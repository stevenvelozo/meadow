# MySQL Provider

> Production-ready MySQL/MariaDB integration with connection pooling and named placeholders

The MySQL provider connects Meadow to MySQL and MariaDB databases via the [mysql2](https://github.com/sidorares/node-mysql2) library. It uses connection pooling for efficient resource management and named placeholders for safe parameter binding.

## Setup

### Install Dependencies

```bash
npm install meadow meadow-connection-mysql
```

### Register the Connection

```javascript
const libFable = require('fable').new(
	{
		MySQL:
		{
			Server: 'localhost',
			Port: 3306,
			User: 'root',
			Password: '',
			Database: 'myapp',
			ConnectionPoolLimit: 20
		}
	});

const libMeadowConnectionMySQL = require('meadow-connection-mysql');

// Register and instantiate the connection service
libFable.serviceManager.addServiceType('MeadowMySQLProvider', libMeadowConnectionMySQL);
libFable.serviceManager.instantiateServiceProvider('MeadowMySQLProvider',
	{ MeadowConnectionMySQLAutoConnect: true });
```

### Create a Meadow DAL

```javascript
const libMeadow = require('meadow');

const meadow = libMeadow.new(libFable, 'Book')
	.setProvider('MySQL')
	.setDefaultIdentifier('IDBook')
	.setSchema([
		{ Column: 'IDBook', Type: 'AutoIdentity' },
		{ Column: 'GUIDBook', Type: 'AutoGUID' },
		{ Column: 'Title', Type: 'String', Size: '255' },
		{ Column: 'Author', Type: 'String', Size: '128' },
		{ Column: 'CreateDate', Type: 'CreateDate' },
		{ Column: 'CreatingIDUser', Type: 'CreateIDUser' },
		{ Column: 'UpdateDate', Type: 'UpdateDate' },
		{ Column: 'UpdatingIDUser', Type: 'UpdateIDUser' },
		{ Column: 'DeleteDate', Type: 'DeleteDate' },
		{ Column: 'DeletingIDUser', Type: 'DeleteIDUser' },
		{ Column: 'Deleted', Type: 'Deleted' }
	]);
```

## Connection Management

### Connection Pool

The MySQL provider uses a connection pool managed by `meadow-connection-mysql`. Each CRUD operation:

1. Acquires a connection from the pool via `pool.getConnection()`
2. Executes the generated SQL query
3. Releases the connection back to the pool

This ensures efficient reuse of database connections across concurrent requests.

### Pool Access

The provider looks for the connection pool in two locations (for backward compatibility):

| Property | Description |
|----------|-------------|
| `fable.MeadowMySQLProvider.pool` | New-style: registered Fable service |
| `fable.MeadowMySQLConnectionPool` | Legacy: directly assigned pool |

### Connection Configuration

| Setting | Type | Default | Description |
|---------|------|---------|-------------|
| `MySQL.Server` | string | — | Database server hostname |
| `MySQL.Port` | number | `3306` | Database server port |
| `MySQL.User` | string | — | Database user |
| `MySQL.Password` | string | — | Database password |
| `MySQL.Database` | string | — | Database name |
| `MySQL.ConnectionPoolLimit` | number | `20` | Maximum pool connections |

### Named Placeholders

The MySQL provider enables `namedPlaceholders: true` on the connection pool, which allows FoxHound to generate queries with named parameter binding:

```sql
-- Generated by FoxHound with named placeholders:
SELECT IDBook, Title, Author FROM Book WHERE IDBook = :IDBook AND Deleted = 0
```

## CRUD Operations

### Create

Executes an INSERT statement and returns the auto-generated identity value.

```javascript
meadow.doCreate(
	meadow.query.addRecord({ Title: 'Dune', Author: 'Frank Herbert' }),
	(pError, pCreateQuery, pReadQuery, pRecord) =>
	{
		console.log('New ID:', pRecord.IDBook);
	});
```

**Internally:**
- Builds query: `pQuery.setDialect('MySQL').buildCreateQuery()`
- Extracts identity: `result.insertId`
- If `insertId` extraction fails, logs a warning with the query body for debugging

### Read

Executes a SELECT statement and returns the result rows.

```javascript
// Single record
meadow.doRead(
	meadow.query.addFilter('IDBook', 42),
	(pError, pQuery, pRecord) =>
	{
		console.log('Title:', pRecord.Title);
	});

// Multiple records
meadow.doReads(
	meadow.query.setCap(25).setBegin(0).addSort({ Column: 'Title', Direction: 'ASC' }),
	(pError, pQuery, pRecords) =>
	{
		pRecords.forEach((pBook) => console.log(pBook.Title));
	});
```

**Internally:**
- Builds query: `pQuery.setDialect('MySQL').buildReadQuery()`
- Returns full result array

### Update

Executes an UPDATE statement.

```javascript
meadow.doUpdate(
	meadow.query
		.addFilter('IDBook', 42)
		.addRecord({ Title: 'Updated Title' }),
	(pError, pUpdateQuery, pReadQuery, pRecord) =>
	{
		console.log('Updated:', pRecord.Title);
	});
```

**Internally:**
- Builds query: `pQuery.setDialect('MySQL').buildUpdateQuery()`

### Delete

Executes a soft delete (UPDATE setting Deleted flag) and returns the affected row count.

```javascript
meadow.doDelete(
	meadow.query.addFilter('IDBook', 42),
	(pError, pQuery, pResult) =>
	{
		console.log('Deleted rows:', pResult);
	});
```

**Internally:**
- Builds query: `pQuery.setDialect('MySQL').buildDeleteQuery()`
- Extracts affected rows: `result.affectedRows`

### Undelete

Reverses a soft delete and returns the affected row count.

```javascript
meadow.doUndelete(
	meadow.query.addFilter('IDBook', 42),
	(pError, pQuery, pResult) =>
	{
		console.log('Restored rows:', pResult);
	});
```

**Internally:**
- Builds query: `pQuery.setDialect('MySQL').buildUndeleteQuery()`
- Extracts affected rows: `result.affectedRows`

### Count

Executes a COUNT query and returns the integer count.

```javascript
meadow.doCount(
	meadow.query,
	(pError, pQuery, pCount) =>
	{
		console.log('Total books:', pCount);
	});
```

**Internally:**
- Builds query: `pQuery.setDialect('MySQL').buildCountQuery()`
- Extracts count: `result[0].RowCount`

## Query Logging

The MySQL provider supports query logging controlled by the `GlobalLogLevel` Fable setting:

| Level | Behavior |
|-------|----------|
| `0` (default) | No query logging |
| `> 0` | Logs trace-level messages for each query executed |

```javascript
const libFable = require('fable').new(
	{
		GlobalLogLevel: 1,
		MySQL: { /* ... */ }
	});
```

## Error Handling

All operations follow the same error handling pattern:

- Database errors are stored in `pQuery.parameters.result.error`
- If the identity/rowcount extraction fails after a successful query, a warning is logged with the original query body
- Connection errors bubble up through the callback as `pError`

## Docker Development

For local MySQL development:

```bash
docker run -d \
	--name meadow-mysql \
	-e MYSQL_ROOT_PASSWORD=password \
	-e MYSQL_DATABASE=myapp \
	-p 3306:3306 \
	mysql:8
```

## Related Documentation

- [Providers Overview](providers/README.md) — Comparison of all providers
- [MSSQL Provider](providers/mssql.md) — Microsoft SQL Server alternative
- [meadow-connection-mysql](https://github.com/stevenvelozo/meadow-connection-mysql) — Connection module source
